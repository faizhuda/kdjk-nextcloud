name: Tes smoke Compose

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Siapkan Docker Compose (v2)
        uses: docker/setup-buildx-action@v2

      - name: Mulai layanan
        run: |
          docker compose -f docker-compose.yml up -d

      - name: Tunggu status sehat (app)
        run: |
          for i in {1..30}; do
            status=$(docker inspect --format='{{.State.Health.Status}}' nc-tristan-app || echo unknown)
            echo "Percobaan $i: status app = $status"
            if [ "$status" = "healthy" ]; then exit 0; fi
            sleep 5
          done
          docker compose logs --no-color
          exit 1

      - name: Permintaan smoke (cek endpoint)
        run: |
          docker exec nc-tristan-app curl -f http://localhost/status.php

      - name: Jalankan skrip backup
        run: |
          chmod +x ./scripts/backup.sh
          ./scripts/backup.sh ./backups

      - name: Hentikan layanan
        if: always()
        run: |
          docker compose -f docker-compose.yml down -v
