name: Tes smoke Compose

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Siapkan Docker Compose (v2)
        uses: docker/setup-buildx-action@v2

      - name: Buat .env sementara untuk CI
        run: |
          set -e
          # buat password acak untuk CI (tidak disimpan di repo)
          if command -v openssl >/dev/null 2>&1; then
            PASSWORD=$(openssl rand -hex 16)
          else
            PASSWORD=$(date +%s)
          fi
          mkdir -p ci_data/db ci_data/nc
          # Tulis file .env secara aman tanpa heredoc untuk menghindari masalah parsing YAML
          # Sertakan NEXTCLOUD_ADMIN_* agar Nextcloud dapat melakukan instalasi otomatis di CI
          printf 'MARIADB_ROOT_PASSWORD=%s\nMYSQL_DATABASE=nextcloud\nMYSQL_USER=nextcloud\nMYSQL_PASSWORD=%s\nDB_VOLUME_PATH=./ci_data/db\nNC_VOLUME_PATH=./ci_data/nc\nNEXTCLOUD_ADMIN_USER=ciadmin\nNEXTCLOUD_ADMIN_PASSWORD=%s\n' "$PASSWORD" "$PASSWORD" "$PASSWORD" > .env

      - name: Sembunyikan config.php agar instalasi awal berjalan
        run: |
          if [ -e ./config.php ]; then
            if [ -f ./config.php ]; then
              mv ./config.php ./config.php.ci.bak
            else
              mv ./config.php ./config.php.ci.bak.dir
            fi
            echo "config.php dipindahkan sementara"
          else
            echo "Tidak ada config.php di repo, lanjut"
          fi
      - name: Mulai layanan (db lalu app)
        run: |
          # Start only the database first so it finishes initialization
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d db

          # Tunggu sampai container DB sehat (healthcheck di compose)
          for i in {1..30}; do
            status=$(docker inspect --format='{{.State.Health.Status}}' nc-tristan-db || echo unknown)
            echo "Percobaan $i: status db = $status"
            if [ "$status" = "healthy" ]; then
              echo "DB sehat, melanjutkan..."
              break
            fi
            sleep 2
          done

          status=$(docker inspect --format='{{.State.Health.Status}}' nc-tristan-db || echo unknown)
          if [ "$status" != "healthy" ]; then
            echo "DB tidak menjadi sehat, keluaran logs:";
            docker compose -f docker-compose.yml -f docker-compose.ci.yml logs --no-color db || true
            exit 1
          fi

          # Now start the app so it can perform automated installation against the ready DB
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d app

      - name: Tunggu status.php siap; fallback ke OCC install jika perlu
        run: |
          # Ambil kredensial dari .env yang kita buat
          NEXT_ADMIN=$(grep -E '^NEXTCLOUD_ADMIN_USER=' .env | cut -d= -f2)
          NEXT_PASS=$(grep -E '^NEXTCLOUD_ADMIN_PASSWORD=' .env | cut -d= -f2)
          DB_PASS=$(grep -E '^MYSQL_PASSWORD=' .env | cut -d= -f2)

          check_status() {
            code=$(docker exec nc-tristan-app curl -s -o /dev/null -w "%{http_code}" http://localhost/status.php || echo 000)
            echo "$code"
          }

          for i in {1..30}; do
            code=$(check_status)
            echo "Percobaan $i: status.php HTTP $code"
            if [ "$code" = "200" ]; then
              echo "status.php siap"
              exit 0
            fi
            sleep 5
          done

          echo "status.php tetap tidak respons 200 â€” mencoba instalasi otomatis via occ"

          # Jalankan OCC install sebagai fallback
          if [ -n "$NEXT_ADMIN" ] && [ -n "$NEXT_PASS" ]; then
            docker exec -u www-data nc-tristan-app php occ maintenance:install \
              --database "mysql" \
              --database-name nextcloud \
              --database-user nextcloud \
              --database-pass "$DB_PASS" \
              --database-host db \
              --admin-user "$NEXT_ADMIN" \
              --admin-pass "$NEXT_PASS" || true
          else
            echo "Kredensial admin tidak ditemukan, tidak dapat menjalankan occ install"
          fi

          # Tunggu lagi untuk status.php
          for i in {1..30}; do
            code=$(check_status)
            echo "Retry $i: status.php HTTP $code"
            if [ "$code" = "200" ]; then
              echo "status.php siap setelah OCC install"
              exit 0
            fi
            sleep 5
          done

          echo "status.php masih gagal setelah percobaan; tampilkan logs dan gagal"
          docker compose -f docker-compose.yml -f docker-compose.ci.yml logs --no-color app || true
          exit 1

      - name: Permintaan smoke (cek endpoint)
        run: |
          docker exec nc-tristan-app curl -f http://localhost/status.php

      - name: Jalankan skrip backup
        run: |
          chmod +x ./scripts/backup.sh
          ./scripts/backup.sh ./backups

      - name: Hentikan layanan
        if: always()
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml down -v
          # kembalikan config.php jika kita memindahkannya
          if [ -f ./config.php.ci.bak ]; then
            rm -rf ./config.php || true
            mv ./config.php.ci.bak ./config.php
            chmod 644 ./config.php || true
            echo "config.php dikembalikan (file)"
          fi
          if [ -d ./config.php.ci.bak.dir ]; then
            rm -rf ./config.php || true
            mv ./config.php.ci.bak.dir ./config.php
            echo "config.php dikembalikan (direktori)"
          fi
