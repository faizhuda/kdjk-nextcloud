name: Tes smoke Compose

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Siapkan Docker Compose (v2)
        uses: docker/setup-buildx-action@v2

      - name: Buat .env sementara untuk CI
        run: |
          set -e
          # buat password acak untuk CI (tidak disimpan di repo)
          if command -v openssl >/dev/null 2>&1; then
            PASSWORD=$(openssl rand -hex 16)
          else
            PASSWORD=$(date +%s)
          fi
          mkdir -p ci_data/db ci_data/nc
          # Tulis file .env secara aman tanpa heredoc untuk menghindari masalah parsing YAML
          # Sertakan NEXTCLOUD_ADMIN_* agar Nextcloud dapat melakukan instalasi otomatis di CI
          printf 'MARIADB_ROOT_PASSWORD=%s\nMYSQL_DATABASE=nextcloud\nMYSQL_USER=nextcloud\nMYSQL_PASSWORD=%s\nDB_VOLUME_PATH=./ci_data/db\nNC_VOLUME_PATH=./ci_data/nc\nNEXTCLOUD_ADMIN_USER=ciadmin\nNEXTCLOUD_ADMIN_PASSWORD=%s\n' "$PASSWORD" "$PASSWORD" "$PASSWORD" > .env

      - name: Sembunyikan config.php agar instalasi awal berjalan
        run: |
          if [ -e ./config.php ]; then
            if [ -f ./config.php ]; then
              mv ./config.php ./config.php.ci.bak
            else
              mv ./config.php ./config.php.ci.bak.dir
            fi
            echo "config.php dipindahkan sementara"
          else
            echo "Tidak ada config.php di repo, lanjut"
          fi
      - name: Mulai layanan
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d

      - name: Tunggu status sehat (app)
        run: |
          for i in {1..30}; do
            status=$(docker inspect --format='{{.State.Health.Status}}' nc-tristan-app || echo unknown)
            echo "Percobaan $i: status app = $status"
            if [ "$status" = "healthy" ]; then exit 0; fi
            sleep 5
          done
          docker compose logs --no-color
          exit 1

      - name: Permintaan smoke (cek endpoint)
        run: |
          docker exec nc-tristan-app curl -f http://localhost/status.php

      - name: Jalankan skrip backup
        run: |
          chmod +x ./scripts/backup.sh
          ./scripts/backup.sh ./backups

      - name: Hentikan layanan
        if: always()
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml down -v
          # kembalikan config.php jika kita memindahkannya
          if [ -f ./config.php.ci.bak ]; then
            rm -rf ./config.php || true
            mv ./config.php.ci.bak ./config.php
            chmod 644 ./config.php || true
            echo "config.php dikembalikan (file)"
          fi
          if [ -d ./config.php.ci.bak.dir ]; then
            rm -rf ./config.php || true
            mv ./config.php.ci.bak.dir ./config.php
            echo "config.php dikembalikan (direktori)"
          fi
